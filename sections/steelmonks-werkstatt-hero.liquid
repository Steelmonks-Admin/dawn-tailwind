{% comment %}
  Steelmonks Glass Carousel, standalone
  Multiple cards visible, center card highlighted
  Per card: base image + full screen overlay image (same size, 2s fade in)
  Prompt bar at bottom shows active slide prompt
{% endcomment %}

{% schema %}
{
  "name": "Werkstatt Glass Carousel",
  "tag": "section",
  "settings": [
    { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": true },
    { "type": "range", "id": "autoplay_seconds", "label": "Autoplay Sekunden", "default": 6, "min": 3, "max": 12, "step": 1 }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "image_picker", "id": "base_image", "label": "Basisbild" },
        { "type": "image_picker", "id": "overlay_image", "label": "Overlay Bild (Schild)" },
        { "type": "textarea", "id": "prompt", "label": "Prompt unten", "default": "Beispiel Prompt: Modernes Hausschild, klare Konturen, minimalistisch, Familienname und Hausnummer" },
        { "type": "text", "id": "btn_off", "label": "Button Text vorher", "default": "In Schild verwandeln" },
        { "type": "text", "id": "btn_on", "label": "Button Text nachher", "default": "Zurück" }
      ]
    }
  ],
  "presets": [
    { "name": "Werkstatt Glass Carousel", "blocks": [{ "type": "slide" }, { "type": "slide" }, { "type": "slide" }, { "type": "slide" }] }
  ]
}
{% endschema %}

<section id="smc-{{ section.id }}" class="smc" aria-label="Werkstatt Carousel">
  <style>
    #smc-{{ section.id }}{
      --ink: rgba(9,10,12,0.92);
      --muted: rgba(9,10,12,0.66);

      --a1: #ff9800;
      --a2: #0044CC;
      --a3: #00235e;

      --stroke: rgba(255,255,255,0.18);
      --stroke2: rgba(9,10,12,0.10);

      --shadow: 0 22px 70px rgba(15,23,42,0.18);
      --shadow2: 0 14px 34px rgba(15,23,42,0.12);

      --rOuter: 34px;
      --rInner: 26px;

      --cardW: clamp(230px, 62vw, 340px);
      --cardH: clamp(360px, 72svh, 560px);
      --gap: 14px;

      --fade: 2000ms;

      min-height: 100svh;
      display: grid;
      place-items: center;
      padding: 18px 14px;
      color: var(--ink);
      background:
        radial-gradient(120% 90% at 20% 0%, rgba(255,152,0,0.20), rgba(255,255,255,0) 58%),
        radial-gradient(120% 90% at 85% 0%, rgba(0,68,204,0.20), rgba(255,255,255,0) 60%),
        radial-gradient(120% 120% at 50% 120%, rgba(0,35,94,0.14), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, rgba(255,255,255,0.30), rgba(255,255,255,0.06));
    }

    #smc-{{ section.id }} .smc__wrap{
      width: min(1220px, 100%);
      border-radius: var(--rOuter);
      border: 1px solid rgba(255,255,255,0.16);
      background:
        radial-gradient(100% 80% at 20% 0%, rgba(255,255,255,0.40), rgba(255,255,255,0.16) 55%),
        linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.10));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }

    #smc-{{ section.id }} .smc__wrap:before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: calc(var(--rOuter) + 2px);
      background:
        radial-gradient(90% 70% at 15% 10%, rgba(255,152,0,0.38), rgba(255,255,255,0) 60%),
        radial-gradient(90% 70% at 85% 10%, rgba(0,68,204,0.32), rgba(255,255,255,0) 60%);
      filter: blur(10px);
      opacity: 0.55;
      pointer-events:none;
      z-index:0;
    }

    #smc-{{ section.id }} .smc__wrap > *{ position: relative; z-index: 1; }

    #smc-{{ section.id }} .smc__top{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 14px 10px;
    }

    #smc-{{ section.id }} .smc__title{
      margin: 0;
      font-weight: 950;
      letter-spacing: -0.02em;
      font-size: 13px;
      color: rgba(9,10,12,0.78);
      user-select: none;
    }

    #smc-{{ section.id }} .smc__nav{
      display: inline-flex;
      gap: 10px;
      align-items: center;
    }

    #smc-{{ section.id }} .smc__btn{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.24);
      background: rgba(255,255,255,0.14);
      box-shadow: 0 14px 28px rgba(15,23,42,0.10);
      display: grid;
      place-items: center;
      cursor: pointer;
      color: rgba(9,10,12,0.78);
      transition: transform 180ms cubic-bezier(0.2,0.8,0.2,1), filter 180ms ease, background 180ms ease;
      -webkit-tap-highlight-color: transparent;
    }

    #smc-{{ section.id }} .smc__btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.03);
      background: rgba(255,255,255,0.18);
    }
    #smc-{{ section.id }} .smc__btn:active{ transform: translateY(0) scale(0.98); }
    #smc-{{ section.id }} .smc__btn:focus-visible{ outline: 3px solid rgba(0,68,204,0.35); outline-offset: 2px; }

    #smc-{{ section.id }} .smc__viewport{
      padding: 8px 6px 4px;
    }

    #smc-{{ section.id }} .smc__track{
      display: flex;
      gap: var(--gap);
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-padding: 18px;
      padding: 10px 16px 14px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    #smc-{{ section.id }} .smc__track::-webkit-scrollbar{ display:none; }

    #smc-{{ section.id }} .smc__card{
      flex: 0 0 var(--cardW);
      height: var(--cardH);
      scroll-snap-align: center;
      border-radius: var(--rInner);
      position: relative;
      overflow: hidden;
      transform: translateZ(0);
      background:
        radial-gradient(120% 90% at 25% 0%, rgba(255,152,0,0.12), rgba(255,255,255,0) 58%),
        radial-gradient(120% 90% at 85% 0%, rgba(0,68,204,0.10), rgba(255,255,255,0) 58%),
        linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: var(--shadow2);
      opacity: 0.72;
      transform: scale(0.92);
      transition: transform 520ms cubic-bezier(0.2,0.8,0.2,1), opacity 520ms ease, filter 520ms ease;
      will-change: transform, opacity, filter;
    }

    #smc-{{ section.id }} .smc__card.is-active{
      opacity: 1;
      transform: scale(1);
      filter: saturate(1.03) contrast(1.02);
      border-color: rgba(255,255,255,0.26);
    }

    #smc-{{ section.id }} .smc__img,
    #smc-{{ section.id }} .smc__overlay{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #smc-{{ section.id }} .smc__img{
      transform: scale(1.02);
      transition: transform 700ms cubic-bezier(0.2,0.8,0.2,1), filter 520ms ease;
      will-change: transform, filter;
    }

    #smc-{{ section.id }} .smc__card.is-active .smc__img{
      transform: scale(1.06);
      filter: saturate(0.98);
    }

    #smc-{{ section.id }} .smc__overlayWrap{
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    #smc-{{ section.id }} .smc__overlay{
      opacity: 0;
      transition: opacity var(--fade) ease;
      will-change: opacity;
    }

    #smc-{{ section.id }} .smc__card.is-on .smc__overlay{
      opacity: 1;
    }

    #smc-{{ section.id }} .smc__card.is-on .smc__img{
      filter: blur(1.2px) brightness(0.88) saturate(0.90);
    }

    #smc-{{ section.id }} .smc__edge{
      position:absolute;
      inset: 0;
      pointer-events:none;
      background:
        radial-gradient(130% 90% at 50% 0%, rgba(255,255,255,0.14), rgba(255,255,255,0) 56%),
        radial-gradient(120% 120% at 50% 120%, rgba(0,0,0,0.22), rgba(0,0,0,0) 58%);
      opacity: 0.70;
    }

    #smc-{{ section.id }} .smc__toggle{
      position: absolute;
      top: 12px;
      right: 12px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.16);
      box-shadow: 0 18px 42px rgba(0,0,0,0.18);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      color: rgba(255,255,255,0.96);
      font-weight: 950;
      font-size: 12px;
      letter-spacing: 0.2px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 180ms cubic-bezier(0.2,0.8,0.2,1), filter 180ms ease, background 180ms ease;
    }

    #smc-{{ section.id }} .smc__toggle:hover{
      transform: translateY(-1px);
      filter: brightness(1.04);
      background: rgba(255,255,255,0.20);
    }
    #smc-{{ section.id }} .smc__toggle:active{ transform: translateY(0) scale(0.99); }
    #smc-{{ section.id }} .smc__toggle:focus-visible{ outline: 3px solid rgba(255,152,0,0.50); outline-offset: 2px; }

    #smc-{{ section.id }} .smc__toggleIcon{
      width: 18px;
      height: 18px;
      display: inline-block;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.26));
    }

    #smc-{{ section.id }} .smc__toggleDot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--a1), var(--a2));
      box-shadow: 0 0 0 6px rgba(255,152,0,0.18);
    }

    #smc-{{ section.id }} .smc__card.is-on .smc__toggle{
      background: linear-gradient(90deg, rgba(0,35,94,0.88), rgba(0,68,204,0.88));
      border-color: rgba(255,255,255,0.20);
      box-shadow: 0 20px 54px rgba(0,35,94,0.26);
    }

    /* Prompt bar bottom */
    #smc-{{ section.id }} .smc__promptWrap{
      padding: 10px 14px 16px;
      display: grid;
      gap: 10px;
    }

    #smc-{{ section.id }} .smc__prompt{
      width: 100%;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.14);
      box-shadow: 0 18px 42px rgba(15,23,42,0.10);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 12px 12px;
      color: rgba(9,10,12,0.82);
      font-weight: 850;
      font-size: 12.5px;
      line-height: 1.35;
      letter-spacing: 0.1px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      min-height: 52px;
    }

    #smc-{{ section.id }} .smc__dots{
      display: flex;
      gap: 8px;
      justify-content: center;
      padding-bottom: 12px;
    }

    #smc-{{ section.id }} .smc__dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.12);
      cursor: pointer;
      transition: width 220ms cubic-bezier(0.2,0.8,0.2,1), transform 220ms cubic-bezier(0.2,0.8,0.2,1), background 220ms ease;
    }

    #smc-{{ section.id }} .smc__dot.is-active{
      width: 24px;
      background: linear-gradient(90deg, rgba(255,152,0,0.85), rgba(0,68,204,0.85));
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.10);
    }

    @media (min-width: 900px){
      #smc-{{ section.id }}{
        --cardW: 320px;
        --cardH: 540px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      #smc-{{ section.id }} *{
        transition: none !important;
        animation: none !important;
        scroll-behavior: auto !important;
      }
    }
  </style>

  <div class="smc__wrap">
    <div class="smc__top">
      <p class="smc__title">Werkstatt Beispiele</p>
      <div class="smc__nav" aria-label="Navigation">
        <button class="smc__btn" type="button" data-smc-prev aria-label="Vorheriges">‹</button>
        <button class="smc__btn" type="button" data-smc-next aria-label="Nächstes">›</button>
      </div>
    </div>

    <div class="smc__viewport">
      <div class="smc__track" data-smc-track>
        {% for block in section.blocks %}
          {% if block.type == 'slide' %}
            <div class="smc__card" data-smc-card data-index="{{ forloop.index0 }}" data-prompt="{{ block.settings.prompt | escape }}" {{ block.shopify_attributes }}>
              {% if block.settings.base_image != blank %}
                <img class="smc__img" src="{{ block.settings.base_image | image_url: width: 1800 }}" alt="{{ block.settings.base_image.alt | escape }}" loading="lazy" width="1800" height="2400">
              {% else %}
                <div class="smc__img" aria-hidden="true"></div>
              {% endif %}

              <div class="smc__overlayWrap" aria-hidden="true">
                {% if block.settings.overlay_image != blank %}
                  <img class="smc__overlay" src="{{ block.settings.overlay_image | image_url: width: 1800 }}" alt="" loading="lazy" width="1800" height="2400">
                {% else %}
                  <div class="smc__overlay" aria-hidden="true"></div>
                {% endif %}
              </div>

              <div class="smc__edge" aria-hidden="true"></div>

              <button
                type="button"
                class="smc__toggle"
                data-smc-toggle
                data-label-off="{{ block.settings.btn_off | escape }}"
                data-label-on="{{ block.settings.btn_on | escape }}"
                aria-pressed="false"
                aria-label="{{ block.settings.btn_off | escape }}"
              >
                <span class="smc__toggleDot" aria-hidden="true"></span>
                <svg class="smc__toggleIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 2l1.2 4.2L17.4 7.4 13.2 8.6 12 13 10.8 8.6 6.6 7.4l4.2-1.2L12 2Z" stroke="rgba(255,255,255,0.92)" stroke-width="1.6" stroke-linejoin="round"/>
                  <path d="M19 11l.9 3.1 3.1.9-3.1.9L19 19l-.9-3.1L15 15l3.1-.9L19 11Z" stroke="rgba(255,255,255,0.92)" stroke-width="1.6" stroke-linejoin="round"/>
                  <path d="M5 13l.8 2.7 2.7.8-2.7.8L5 20l-.8-2.7L1.5 16.5l2.7-.8L5 13Z" stroke="rgba(255,255,255,0.92)" stroke-width="1.6" stroke-linejoin="round"/>
                </svg>
                <span class="smc__toggleText">{{ block.settings.btn_off | escape }}</span>
              </button>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="smc__promptWrap" aria-label="Prompt">
      <div class="smc__prompt" data-smc-prompt> </div>
    </div>

    <div class="smc__dots" data-smc-dots aria-label="Punkte"></div>
  </div>

  <script>
    (function(){
      var SECTION_ID = "{{ section.id }}";
      var root = document.getElementById("smc-" + SECTION_ID);
      if(!root) return;

      var track = root.querySelector("[data-smc-track]");
      var cards = Array.prototype.slice.call(root.querySelectorAll("[data-smc-card]"));
      var prev = root.querySelector("[data-smc-prev]");
      var next = root.querySelector("[data-smc-next]");
      var promptEl = root.querySelector("[data-smc-prompt]");
      var dotsWrap = root.querySelector("[data-smc-dots]");

      if(!track || !cards.length) return;

      var autoplay = {{ section.settings.autoplay | json }};
      var autoplayMs = ({{ section.settings.autoplay_seconds | default: 6 }} * 1000) || 6000;
      var timer = null;
      var isPointerDown = false;

      function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

      function getActiveIndex(){
        var t = track.getBoundingClientRect();
        var cx = t.left + t.width / 2;
        var best = 0;
        var dist = Infinity;

        for(var i=0;i<cards.length;i++){
          var r = cards[i].getBoundingClientRect();
          var c = r.left + r.width / 2;
          var d = Math.abs(c - cx);
          if(d < dist){
            dist = d;
            best = i;
          }
        }
        return best;
      }

      function setActive(idx){
        for(var i=0;i<cards.length;i++){
          if(i === idx) cards[i].classList.add("is-active");
          else cards[i].classList.remove("is-active");
        }

        if(promptEl){
          var p = cards[idx].getAttribute("data-prompt") || "";
          promptEl.textContent = p;
        }

        if(dotsWrap){
          var dots = dotsWrap.querySelectorAll(".smc__dot");
          for(var j=0;j<dots.length;j++){
            if(j === idx) dots[j].classList.add("is-active");
            else dots[j].classList.remove("is-active");
          }
        }
      }

      function scrollToIndex(idx){
        idx = clamp(idx, 0, cards.length - 1);
        cards[idx].scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
        setActive(idx);
      }

      function step(dir){
        var idx = getActiveIndex();
        scrollToIndex(idx + dir);
      }

      function buildDots(){
        if(!dotsWrap) return;
        dotsWrap.innerHTML = "";
        for(var i=0;i<cards.length;i++){
          var b = document.createElement("button");
          b.type = "button";
          b.className = "smc__dot" + (i === 0 ? " is-active" : "");
          b.setAttribute("aria-label", "Gehe zu Slide " + (i + 1));
          (function(index){
            b.addEventListener("click", function(){
              stopAutoplay();
              scrollToIndex(index);
            });
          })(i);
          dotsWrap.appendChild(b);
        }
      }

      function startAutoplay(){
        if(!autoplay) return;
        stopAutoplay();
        timer = setInterval(function(){
          if(isPointerDown) return;
          var idx = getActiveIndex();
          var nxt = (idx + 1) % cards.length;
          scrollToIndex(nxt);
        }, autoplayMs);
      }

      function stopAutoplay(){
        if(timer){ clearInterval(timer); timer = null; }
      }

      function bind(){
        if(prev) prev.addEventListener("click", function(){ stopAutoplay(); step(-1); });
        if(next) next.addEventListener("click", function(){ stopAutoplay(); step(1); });

        track.addEventListener("scroll", function(){
          setActive(getActiveIndex());
        }, { passive: true });

        track.addEventListener("pointerdown", function(){ isPointerDown = true; stopAutoplay(); }, { passive: true });
        window.addEventListener("pointerup", function(){ isPointerDown = false; startAutoplay(); }, { passive: true });

        root.querySelectorAll("[data-smc-toggle]").forEach(function(btn){
          btn.addEventListener("click", function(){
            var card = btn.closest("[data-smc-card]");
            if(!card) return;

            var isOn = card.classList.toggle("is-on");
            btn.setAttribute("aria-pressed", isOn ? "true" : "false");

            var off = btn.getAttribute("data-label-off") || "In Schild verwandeln";
            var on = btn.getAttribute("data-label-on") || "Zurück";
            var label = isOn ? on : off;

            var t = btn.querySelector(".smc__toggleText");
            if(t) t.textContent = label;
            btn.setAttribute("aria-label", label);
          });
        });
      }

      buildDots();
      bind();

      setActive(0);
      startAutoplay();

      var ro = new ResizeObserver(function(){
        setActive(getActiveIndex());
      });
      ro.observe(track);

      document.addEventListener("shopify:section:load", function(e){
        if(!e || !e.detail || !e.detail.sectionId) return;
        if(String(e.detail.sectionId) !== String(SECTION_ID)) return;
        stopAutoplay();
      });
    })();
  </script>
</section>