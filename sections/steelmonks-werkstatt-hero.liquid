{% comment %}
  Steelmonks Floating Glass Carousel (standalone, no big frame)
  - Each card is its own floating glass element (no overall background panel)
  - Multiple cards visible, center card highlighted
  - Square images always
  - No heading, no dots
  - Arrows aligned inside carousel, right side
  - Active card shows top-center button: "Verwandeln"
  - Bottom prompt bar (desktop hover/focus, mobile always)
  - Overlay image full size (same as base), 2s slow fade in
  - Includes 2 default example slides using theme assets:
    Werkstatt-Hero-1 + Werkstatt-Hero-1-Overlay
    Werkstatt-Hero-2-First + Werkstatt-Hero-2-Overlay
{% endcomment %}

{% schema %}
{
  "name": "Werkstatt Carousel",
  "tag": "section",
  "settings": [
    { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": true },
    { "type": "range", "id": "autoplay_seconds", "label": "Autoplay Sekunden", "default": 6, "min": 3, "max": 12, "step": 1 }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "image_picker", "id": "base_image", "label": "Basisbild" },
        { "type": "image_picker", "id": "overlay_image", "label": "Overlay Bild (Schild)" },
        { "type": "textarea", "id": "prompt", "label": "Prompt unten", "default": "Beispiel Prompt" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Werkstatt Carousel",
      "blocks": [
        {
          "type": "slide",
          "settings": {
            "prompt": "Ein Bild von genau dem Hund aus dem Photo, die Kappe sollte Schwarz mit dem Logo ausgeschnitten sein."
          }
        },
        {
          "type": "slide",
          "settings": {
            "prompt": "Ein Bild von genau dem schönen Herren aus dem Photo, behalte alle Details bei und mach das Schild Schwarz mit ausgeschnittenen Details."
          }
        }
      ]
    }
  ]
}
{% endschema %}

<section id="smfc-{{ section.id }}" class="smfc" aria-label="Werkstatt Carousel">
  <style>
    #smfc-{{ section.id }}{
      --a1:#ff9800;
      --a2:#0044CC;

      --ink: rgba(9,10,12,0.92);

      --stroke: rgba(255,255,255,0.18);
      --glass: rgba(255,255,255,0.10);

      --shadow: 0 18px 48px rgba(15,23,42,0.14);
      --shadow2: 0 12px 30px rgba(15,23,42,0.12);

      --rCard: 26px;
      --gap: 14px;

      --cardW: clamp(200px, 58vw, 320px);
      --fade: 2000ms;
      --ease: cubic-bezier(0.2,0.8,0.2,1);

      padding: clamp(10px, 2.8vw, 18px);
    }

    #smfc-{{ section.id }} .smfc__wrap{
      width: min(1200px, 100%);
      margin: 0 auto;
      position: relative;
    }

    /* Arrows, aligned inside carousel area (right side) */
    #smfc-{{ section.id }} .smfc__nav{
      position: absolute;
      top: 6px;
      right: 6px;
      display: inline-flex;
      gap: 10px;
      z-index: 5;
      pointer-events: none; /* allow track dragging */
    }

    #smfc-{{ section.id }} .smfc__navbtn{
      pointer-events: auto;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 14px 32px rgba(15,23,42,0.12);
      cursor: pointer;
      display: grid;
      place-items: center;
      color: rgba(9,10,12,0.78);
      transition: transform 180ms var(--ease), filter 180ms ease, background 180ms ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    #smfc-{{ section.id }} .smfc__navbtn:hover{
      transform: translateY(-1px);
      filter: brightness(1.03);
      background: rgba(255,255,255,0.12);
    }
    #smfc-{{ section.id }} .smfc__navbtn:active{ transform: translateY(0) scale(0.98); }
    #smfc-{{ section.id }} .smfc__navbtn:focus-visible{ outline: 3px solid rgba(0,68,204,0.35); outline-offset: 2px; }

    /* Track */
    #smfc-{{ section.id }} .smfc__viewport{
      overflow: visible;
      padding-top: 2px;
    }

    #smfc-{{ section.id }} .smfc__track{
      display: flex;
      gap: var(--gap);
      overflow-x: auto;
      overflow-y: visible;
      scroll-snap-type: x mandatory;
      scroll-padding: 22px;
      padding: 10px 22px 12px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    #smfc-{{ section.id }} .smfc__track::-webkit-scrollbar{ display:none; }

    /* Floating card (own background), no shared container */
    #smfc-{{ section.id }} .smfc__card{
      flex: 0 0 var(--cardW);
      scroll-snap-align: center;
      position: relative;
      border-radius: var(--rCard);
      transform: translateZ(0);
      opacity: 0.78;
      transform: scale(0.92);
      transition: transform 520ms var(--ease), opacity 520ms ease, filter 520ms ease;
      will-change: transform, opacity, filter;
      isolation: isolate;
    }

    /* Glow outline only */
    #smfc-{{ section.id }} .smfc__card:before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: calc(var(--rCard) + 1px);
      padding: 1.5px;
      background: linear-gradient(135deg, rgba(255,152,0,0.70), rgba(0,68,204,0.60));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.34;
      pointer-events: none;
      z-index: 0;
    }

    #smfc-{{ section.id }} .smfc__card:after{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: calc(var(--rCard) + 14px);
      background:
        radial-gradient(60% 60% at 18% 10%, rgba(255,152,0,0.20), rgba(255,255,255,0) 62%),
        radial-gradient(60% 60% at 86% 10%, rgba(0,68,204,0.18), rgba(255,255,255,0) 62%);
      opacity: 0.22;
      filter: blur(12px);
      pointer-events: none;
      z-index: -1;
    }

    #smfc-{{ section.id }} .smfc__card.is-active{
      opacity: 1;
      transform: scale(1.06);
      filter: saturate(1.02) contrast(1.02);
    }
    #smfc-{{ section.id }} .smfc__card.is-active:before{ opacity: 0.78; }
    #smfc-{{ section.id }} .smfc__card.is-active:after{ opacity: 0.46; }

    /* Card glass body */
    #smfc-{{ section.id }} .smfc__frame{
      border-radius: var(--rCard);
      overflow: hidden;
      aspect-ratio: 1 / 1;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }

    #smfc-{{ section.id }} .smfc__img,
    #smfc-{{ section.id }} .smfc__overlay{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #smfc-{{ section.id }} .smfc__img{
      transform: scale(1.02);
      transition: transform 720ms var(--ease), filter 520ms ease;
      will-change: transform, filter;
    }
    #smfc-{{ section.id }} .smfc__card.is-active .smfc__img{ transform: scale(1.06); }

    /* Overlay: same size full card, slow fade */
    #smfc-{{ section.id }} .smfc__overlay{
      opacity: 0;
      transition: opacity var(--fade) ease;
      will-change: opacity;
    }
    #smfc-{{ section.id }} .smfc__card.is-on .smfc__overlay{ opacity: 1; }
    #smfc-{{ section.id }} .smfc__card.is-on .smfc__img{ filter: blur(1.1px) brightness(0.88) saturate(0.92); }

    /* Top-center button only on active */
    #smfc-{{ section.id }} .smfc__toggle{
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(9,10,12,0.18);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      color: rgba(255,255,255,0.96);
      box-shadow: 0 18px 46px rgba(0,0,0,0.18);
      cursor: pointer;
      font-weight: 950;
      font-size: 12.5px;
      letter-spacing: 0.2px;
      -webkit-tap-highlight-color: transparent;
      user-select:none;

      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease, transform 220ms var(--ease), filter 180ms ease, background 180ms ease;
      z-index: 2;
    }

    #smfc-{{ section.id }} .smfc__card.is-active .smfc__toggle{
      opacity: 1;
      pointer-events: auto;
    }

    #smfc-{{ section.id }} .smfc__toggle:hover{ filter: brightness(1.04); }
    #smfc-{{ section.id }} .smfc__toggle:active{ transform: translateX(-50%) scale(0.99); }
    #smfc-{{ section.id }} .smfc__toggle:focus-visible{ outline: 3px solid rgba(255,152,0,0.50); outline-offset: 2px; }

    #smfc-{{ section.id }} .smfc__pillDot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,152,0,0.95), rgba(0,68,204,0.90));
      box-shadow: 0 0 0 6px rgba(255,152,0,0.18);
    }

    #smfc-{{ section.id }} .smfc__card.is-on .smfc__toggle{
      background: linear-gradient(90deg, rgba(0,35,94,0.78), rgba(0,68,204,0.78));
      border-color: rgba(255,255,255,0.16);
      box-shadow: 0 20px 56px rgba(0,35,94,0.22);
    }

    /* Bottom prompt bar */
    #smfc-{{ section.id }} .smfc__promptWrap{
      padding: 10px 22px 6px;
      display: grid;
    }

    #smfc-{{ section.id }} .smfc__prompt{
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
      padding: 14px 14px;
      color: rgba(9,10,12,0.80);
      font-weight: 900;
      font-size: 13px;
      line-height: 1.35;

      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;

      transform: translateY(8px);
      opacity: 0;
      transition: opacity 240ms ease, transform 240ms var(--ease);
    }

    @media (hover:hover){
      #smfc-{{ section.id }} .smfc__wrap:hover .smfc__prompt,
      #smfc-{{ section.id }} .smfc__wrap:focus-within .smfc__prompt{
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (hover:none){
      #smfc-{{ section.id }} .smfc__prompt{
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (min-width: 920px){
      #smfc-{{ section.id }}{ --cardW: 280px; }
      #smfc-{{ section.id }} .smfc__nav{ top: 10px; right: 10px; }
    }

    @media (prefers-reduced-motion: reduce){
      #smfc-{{ section.id }} *{
        transition: none !important;
        animation: none !important;
        scroll-behavior: auto !important;
      }
    }
  </style>

  <div class="smfc__wrap">
    <div class="smfc__nav" aria-label="Navigation">
      <button class="smfc__navbtn" type="button" data-smfc-prev aria-label="Vorheriges">‹</button>
      <button class="smfc__navbtn" type="button" data-smfc-next aria-label="Nächstes">›</button>
    </div>

    <div class="smfc__viewport">
      <div class="smfc__track" data-smfc-track>
        {% for block in section.blocks %}
          {% if block.type == 'slide' %}
            <article class="smfc__card" data-smfc-card data-index="{{ forloop.index0 }}" data-prompt="{{ block.settings.prompt | escape }}" {{ block.shopify_attributes }}>
              <div class="smfc__frame">
                {% liquid
                  assign base = block.settings.base_image
                  assign over = block.settings.overlay_image

                  if base == blank
                    if forloop.index0 == 0
                      assign base = 'Werkstatt-Hero-1' | file_url
                    elsif forloop.index0 == 1
                      assign base = 'Werkstatt-Hero-2-First' | file_url
                    endif
                  endif

                  if over == blank
                    if forloop.index0 == 0
                      assign over = 'Werkstatt-Hero-1-Overlay' | file_url
                    elsif forloop.index0 == 1
                      assign over = 'Werkstatt-Hero-2-Overlay' | file_url
                    endif
                  endif
                %}

                {% if block.settings.base_image != blank %}
                  <img class="smfc__img" src="{{ block.settings.base_image | image_url: width: 1600 }}" alt="{{ block.settings.base_image.alt | escape }}" loading="lazy" width="1600" height="1600">
                {% elsif base != blank %}
                  <img class="smfc__img" src="{{ base }}" alt="Werkstatt Beispiel" loading="lazy" width="1600" height="1600">
                {% else %}
                  <img class="smfc__img" src="https://placehold.co/1600x1600" alt="Placeholder" loading="lazy" width="1600" height="1600">
                {% endif %}

                {% if block.settings.overlay_image != blank %}
                  <img class="smfc__overlay" src="{{ block.settings.overlay_image | image_url: width: 1600 }}" alt="" loading="lazy" width="1600" height="1600">
                {% elsif over != blank %}
                  <img class="smfc__overlay" src="{{ over }}" alt="" loading="lazy" width="1600" height="1600">
                {% else %}
                  <img class="smfc__overlay" src="https://placehold.co/1600x1600" alt="" loading="lazy" width="1600" height="1600">
                {% endif %}

                <button
                  type="button"
                  class="smfc__toggle"
                  data-smfc-toggle
                  aria-pressed="false"
                >
                  <span class="smfc__pillDot" aria-hidden="true"></span>
                  <span class="smfc__toggleText">Verwandeln</span>
                </button>
              </div>
            </article>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="smfc__promptWrap" aria-label="Prompt">
      <div class="smfc__prompt" data-smfc-prompt></div>
    </div>
  </div>

  <script>
    (function(){
      var SECTION_ID = "{{ section.id }}";
      var root = document.getElementById("smfc-" + SECTION_ID);
      if(!root) return;

      var track = root.querySelector("[data-smfc-track]");
      var cards = Array.prototype.slice.call(root.querySelectorAll("[data-smfc-card]"));
      var prev = root.querySelector("[data-smfc-prev]");
      var next = root.querySelector("[data-smfc-next]");
      var promptEl = root.querySelector("[data-smfc-prompt]");

      if(!track || !cards.length) return;

      var autoplay = {{ section.settings.autoplay | json }};
      var autoplayMs = ({{ section.settings.autoplay_seconds | default: 6 }} * 1000) || 6000;
      var timer = null;
      var isPointerDown = false;
      var hoverIdx = null;

      function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

      function getActiveIndex(){
        var t = track.getBoundingClientRect();
        var cx = t.left + t.width / 2;
        var best = 0;
        var dist = Infinity;

        for(var i=0;i<cards.length;i++){
          var r = cards[i].getBoundingClientRect();
          var c = r.left + r.width / 2;
          var d = Math.abs(c - cx);
          if(d < dist){
            dist = d;
            best = i;
          }
        }
        return best;
      }

      function setPromptFromIndex(idx){
        if(!promptEl) return;
        idx = clamp(idx, 0, cards.length - 1);
        promptEl.textContent = cards[idx].getAttribute("data-prompt") || "";
      }

      function setActive(idx){
        idx = clamp(idx, 0, cards.length - 1);
        for(var i=0;i<cards.length;i++){
          if(i === idx) cards[i].classList.add("is-active");
          else cards[i].classList.remove("is-active");
        }

        var showIdx = (hoverIdx !== null) ? hoverIdx : idx;
        setPromptFromIndex(showIdx);
      }

      function scrollToIndex(idx){
        idx = clamp(idx, 0, cards.length - 1);
        cards[idx].scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
        setActive(idx);
      }

      function step(dir){
        var idx = getActiveIndex();
        scrollToIndex(idx + dir);
      }

      function startAutoplay(){
        if(!autoplay) return;
        stopAutoplay();
        timer = setInterval(function(){
          if(isPointerDown) return;
          var idx = getActiveIndex();
          var nxt = (idx + 1) % cards.length;
          scrollToIndex(nxt);
        }, autoplayMs);
      }

      function stopAutoplay(){
        if(timer){ clearInterval(timer); timer = null; }
      }

      function bind(){
        if(prev) prev.addEventListener("click", function(){ stopAutoplay(); step(-1); });
        if(next) next.addEventListener("click", function(){ stopAutoplay(); step(1); });

        track.addEventListener("scroll", function(){
          setActive(getActiveIndex());
        }, { passive: true });

        track.addEventListener("pointerdown", function(){ isPointerDown = true; stopAutoplay(); }, { passive: true });
        window.addEventListener("pointerup", function(){ isPointerDown = false; startAutoplay(); }, { passive: true });

        cards.forEach(function(card, idx){
          card.addEventListener("mouseenter", function(){
            hoverIdx = idx;
            setPromptFromIndex(idx);
          });
          card.addEventListener("mouseleave", function(){
            hoverIdx = null;
            setPromptFromIndex(getActiveIndex());
          });

          // Tap card to center it
          card.addEventListener("click", function(e){
            var target = e.target;
            if(target && target.closest && target.closest("[data-smfc-toggle]")) return;
            stopAutoplay();
            scrollToIndex(idx);
          });
        });

        // Toggle overlay with 2s fade (CSS), only changes that card
        root.querySelectorAll("[data-smfc-toggle]").forEach(function(btn){
          btn.addEventListener("click", function(e){
            e.preventDefault();
            e.stopPropagation();

            var card = btn.closest("[data-smfc-card]");
            if(!card) return;

            var idx = parseInt(card.getAttribute("data-index") || "0", 10);
            if(!card.classList.contains("is-active")){
              stopAutoplay();
              scrollToIndex(idx);
            }

            var isOn = card.classList.toggle("is-on");
            btn.setAttribute("aria-pressed", isOn ? "true" : "false");
            var t = btn.querySelector(".smfc__toggleText");
            if(t) t.textContent = isOn ? "Zurück" : "Verwandeln";
          });
        });
      }

      bind();
      setActive(0);
      startAutoplay();

      var ro = new ResizeObserver(function(){
        setActive(getActiveIndex());
      });
      ro.observe(track);

      document.addEventListener("shopify:section:load", function(e){
        if(!e || !e.detail || !e.detail.sectionId) return;
        if(String(e.detail.sectionId) !== String(SECTION_ID)) return;
        stopAutoplay();
      });
    })();
  </script>
</section>