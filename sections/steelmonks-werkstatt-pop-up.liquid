{% comment %}
  Werkstatt Hinweis Popup
  Zweck
  - On page Popup mit Hintergrund Blur
  - Gläsernes, glossy Modal im Stil eurer Werkstatt Cards
  - Close Button, Overlay Click, ESC
  - Optional automatisch öffnen mit Delay, optional nur einmal pro Session
  - Optional Trigger Button rendern

  Hinweis
  - Komplett section scoped über #smw-popup-{{ section.id }}
{% endcomment %}

{% schema %}
{
  "name": "Werkstatt Hinweis Popup",
  "tag": "section",
  "settings": [
    { "type": "checkbox", "id": "enabled", "label": "Popup aktiv", "default": true },

    { "type": "header", "content": "Öffnen Verhalten" },
    { "type": "checkbox", "id": "auto_open", "label": "Automatisch öffnen", "default": true },
    { "type": "range", "id": "open_delay_seconds", "label": "Delay in Sekunden", "default": 1, "min": 0, "max": 20, "step": 1 },
    { "type": "checkbox", "id": "once_per_session", "label": "Nur einmal pro Session anzeigen", "default": true },

    { "type": "checkbox", "id": "show_trigger_button", "label": "Trigger Button anzeigen", "default": false },
    { "type": "text", "id": "trigger_button_label", "label": "Trigger Button Text", "default": "Was ist die Werkstatt" },

    { "type": "header", "content": "Inhalt" },
    { "type": "text", "id": "badge", "label": "Badge Text", "default": "BETA HINWEIS" },
    { "type": "text", "id": "heading", "label": "Überschrift", "default": "Willkommen in der Werkstatt" },
    { "type": "textarea", "id": "body", "label": "Text", "default": "Unsere Werkstatt ist ein neues Tool, mit dem du dein eigenes Metallschild direkt online gestalten kannst.\n\nBitte behalte im Kopf, das ist eines der ersten Tools dieser Art. Es hängt von mehreren externen Diensten ab, darum kann es in seltenen Fällen haken.\n\nWenn etwas nicht lädt oder sich komisch verhält, lade die Seite neu und probiere es nochmal. Danke, dass du es testest und offen bleibst." },
    { "type": "text", "id": "cta_label", "label": "Primär Button Text", "default": "Alles klar" },
    { "type": "text", "id": "secondary_label", "label": "Sekundär Link Text", "default": "Popup schließen" },

    { "type": "header", "content": "Screenshot" },
    { "type": "checkbox", "id": "show_image", "label": "Screenshot anzeigen", "default": true },
    { "type": "image_picker", "id": "screenshot", "label": "Screenshot aus dem Generator" },
    { "type": "text", "id": "image_caption", "label": "Bild Caption", "default": "Beispiel Ansicht aus der Werkstatt" },

    { "type": "header", "content": "Style" },
    { "type": "range", "id": "modal_max_width", "label": "Modal Max Breite", "default": 860, "min": 520, "max": 1100, "step": 10 },
    { "type": "range", "id": "radius", "label": "Ecken Radius", "default": 26, "min": 14, "max": 40, "step": 1 },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay Deckkraft", "default": 22, "min": 8, "max": 50, "step": 1 },
    { "type": "range", "id": "blur_strength", "label": "Blur Stärke", "default": 14, "min": 6, "max": 24, "step": 1 },

    { "type": "color", "id": "accent_1", "label": "Akzent Farbe 1", "default": "#ff9800" },
    { "type": "color", "id": "accent_2", "label": "Akzent Farbe 2", "default": "#0044CC" },
    { "type": "color", "id": "text_color", "label": "Text Farbe", "default": "#0b1220" },
    { "type": "color", "id": "panel_tint", "label": "Panel Tönung", "default": "#ffffff" }
  ],
  "presets": [
    { "name": "Werkstatt Hinweis Popup" }
  ]
}
{% endschema %}

{% if section.settings.enabled %}
<section id="smw-popup-{{ section.id }}" class="smwpop" data-smwpop-root>
  <style>
    #smw-popup-{{ section.id }}{
      --a1: {{ section.settings.accent_1 }};
      --a2: {{ section.settings.accent_2 }};
      --txt: {{ section.settings.text_color }};
      --panel: {{ section.settings.panel_tint }};

      --r: {{ section.settings.radius }}px;
      --maxW: {{ section.settings.modal_max_width }}px;

      --overlayA: {{ section.settings.overlay_opacity | divided_by: 100.0 }};
      --blur: {{ section.settings.blur_strength }}px;

      --shadow: 0 28px 90px rgba(15,23,42,0.22);
      --shadow2: 0 18px 54px rgba(15,23,42,0.16);

      position: relative;
      z-index: 1;
    }

    /* Optional Trigger Button */
    #smw-popup-{{ section.id }} .smwpop__trigger{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.10);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 46px rgba(15,23,42,0.14);
      cursor: pointer;
      color: rgba(9,10,12,0.82);
      font-weight: 900;
      font-size: 13px;
      letter-spacing: 0.2px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 180ms cubic-bezier(0.2,0.8,0.2,1), filter 180ms ease, background 180ms ease;
    }
    #smw-popup-{{ section.id }} .smwpop__trigger:hover{ filter: brightness(1.03); background: rgba(255,255,255,0.14); }
    #smw-popup-{{ section.id }} .smwpop__trigger:active{ transform: scale(0.98); }
    #smw-popup-{{ section.id }} .smwpop__dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,152,0,0.95), rgba(0,68,204,0.90));
      box-shadow: 0 0 0 6px rgba(255,152,0,0.18);
      flex: 0 0 auto;
    }

    /* Overlay */
    #smw-popup-{{ section.id }} .smwpop__overlay{
      position: fixed;
      inset: 0;
      background: rgba(8,10,14, var(--overlayA));
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      display: none;
      place-items: center;
      padding: 18px 14px;
      z-index: 999999;
    }

    #smw-popup-{{ section.id }}.is-open .smwpop__overlay{
      display: grid;
    }

    /* Panel */
    #smw-popup-{{ section.id }} .smwpop__panel{
      width: min(var(--maxW), 100%);
      border-radius: var(--r);
      position: relative;
      overflow: hidden;
      color: var(--txt);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      transform: translateY(10px) scale(0.995);
      opacity: 0;
      transition: transform 260ms cubic-bezier(0.2,0.8,0.2,1), opacity 240ms ease;
      isolation: isolate;
    }

    #smw-popup-{{ section.id }}.is-open .smwpop__panel{
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    /* Gradient border glow */
    #smw-popup-{{ section.id }} .smwpop__panel:before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: calc(var(--r) + 1px);
      padding: 1.5px;
      background: linear-gradient(135deg, rgba(255,152,0,0.65), rgba(0,68,204,0.58));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.88;
      pointer-events:none;
      z-index: 0;
    }

    /* Soft aura */
    #smw-popup-{{ section.id }} .smwpop__panel:after{
      content:"";
      position:absolute;
      inset:-26px;
      border-radius: calc(var(--r) + 28px);
      background:
        radial-gradient(60% 60% at 18% 10%, rgba(255,152,0,0.18), rgba(255,255,255,0) 62%),
        radial-gradient(60% 60% at 86% 10%, rgba(0,68,204,0.16), rgba(255,255,255,0) 62%);
      opacity: 0.40;
      filter: blur(18px);
      pointer-events:none;
      z-index: -1;
    }

    /* Inner layout */
    #smw-popup-{{ section.id }} .smwpop__inner{
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 1.08fr 0.92fr;
      gap: 18px;
      padding: 18px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
    }

    #smw-popup-{{ section.id }} .smwpop__left{
      display: grid;
      align-content: start;
      gap: 10px;
      padding: 6px;
    }

    #smw-popup-{{ section.id }} .smwpop__badge{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      width: fit-content;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(9,10,12,0.14);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 46px rgba(0,0,0,0.14);
      color: rgba(255,255,255,0.92);
      font-weight: 950;
      font-size: 11.5px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    #smw-popup-{{ section.id }} .smwpop__badgeDot{
      width: 9px; height: 9px; border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,152,0,0.95), rgba(0,68,204,0.90));
      box-shadow: 0 0 0 6px rgba(255,152,0,0.18);
      flex: 0 0 auto;
    }

    #smw-popup-{{ section.id }} .smwpop__title{
      margin: 0;
      font-weight: 980;
      letter-spacing: -0.01em;
      font-size: clamp(18px, 3.8vw, 28px);
      line-height: 1.12;
      color: rgba(9,10,12,0.88);
    }

    #smw-popup-{{ section.id }} .smwpop__text{
      margin: 0;
      font-weight: 850;
      font-size: clamp(13px, 2.9vw, 15.5px);
      line-height: 1.45;
      color: rgba(9,10,12,0.78);
      white-space: pre-line;
    }

    #smw-popup-{{ section.id }} .smwpop__actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
      align-items: center;
    }

    #smw-popup-{{ section.id }} .smwpop__cta{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: linear-gradient(90deg, rgba(0,35,94,0.78), rgba(0,68,204,0.78));
      color: rgba(255,255,255,0.96);
      font-weight: 950;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 20px 56px rgba(0,35,94,0.22);
      transition: transform 180ms cubic-bezier(0.2,0.8,0.2,1), filter 180ms ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    #smw-popup-{{ section.id }} .smwpop__cta:hover{ filter: brightness(1.03); }
    #smw-popup-{{ section.id }} .smwpop__cta:active{ transform: scale(0.985); }

    #smw-popup-{{ section.id }} .smwpop__secondary{
      background: transparent;
      border: 0;
      padding: 10px 10px;
      cursor: pointer;
      color: rgba(9,10,12,0.62);
      font-weight: 900;
      font-size: 13px;
      text-decoration: underline;
      text-underline-offset: 3px;
      -webkit-tap-highlight-color: transparent;
    }

    /* Right image */
    #smw-popup-{{ section.id }} .smwpop__right{
      display: grid;
      align-content: start;
      gap: 10px;
      padding: 6px;
    }

    #smw-popup-{{ section.id }} .smwpop__shot{
      border-radius: calc(var(--r) - 6px);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      position: relative;
      min-height: 220px;
    }

    #smw-popup-{{ section.id }} .smwpop__shot img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: translateZ(0);
    }

    #smw-popup-{{ section.id }} .smwpop__caption{
      margin: 0;
      font-size: 12px;
      font-weight: 850;
      color: rgba(9,10,12,0.58);
      text-align: center;
    }

    /* Close button */
    #smw-popup-{{ section.id }} .smwpop__close{
      position: absolute;
      top: 12px;
      right: 12px;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 16px 40px rgba(15,23,42,0.12);
      cursor: pointer;
      display: grid;
      place-items: center;
      z-index: 3;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 180ms cubic-bezier(0.2,0.8,0.2,1), filter 180ms ease, background 180ms ease;
    }
    #smw-popup-{{ section.id }} .smwpop__close:hover{ filter: brightness(1.03); background: rgba(255,255,255,0.16); }
    #smw-popup-{{ section.id }} .smwpop__close:active{ transform: scale(0.98); }
    #smw-popup-{{ section.id }} .smwpop__close svg{
      width: 18px;
      height: 18px;
      color: rgba(9,10,12,0.78);
      display: block;
    }

    /* Mobile */
    @media (max-width: 820px){
      #smw-popup-{{ section.id }} .smwpop__inner{
        grid-template-columns: 1fr;
      }
      #smw-popup-{{ section.id }} .smwpop__shot{
        min-height: 200px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      #smw-popup-{{ section.id }} *{ transition: none !important; animation: none !important; }
    }
  </style>

  {% if section.settings.show_trigger_button %}
    <button type="button" class="smwpop__trigger" data-smwpop-open>
      <span class="smwpop__dot" aria-hidden="true"></span>
      <span>{{ section.settings.trigger_button_label | escape }}</span>
    </button>
  {% endif %}

  <div class="smwpop__overlay" data-smwpop-overlay role="presentation">
    <div
      class="smwpop__panel"
      role="dialog"
      aria-modal="true"
      aria-label="{{ section.settings.heading | escape }}"
      tabindex="-1"
      data-smwpop-panel
    >
      <button type="button" class="smwpop__close" data-smwpop-close aria-label="Schließen">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 7l10 10M17 7L7 17" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        </svg>
      </button>

      <div class="smwpop__inner">
        <div class="smwpop__left">
          {% if section.settings.badge != blank %}
            <div class="smwpop__badge">
              <span class="smwpop__badgeDot" aria-hidden="true"></span>
              <span>{{ section.settings.badge | escape }}</span>
            </div>
          {% endif %}

          {% if section.settings.heading != blank %}
            <h2 class="smwpop__title">{{ section.settings.heading | escape }}</h2>
          {% endif %}

          {% if section.settings.body != blank %}
            <p class="smwpop__text">{{ section.settings.body | escape }}</p>
          {% endif %}

          <div class="smwpop__actions">
            <button type="button" class="smwpop__cta" data-smwpop-close>
              {{ section.settings.cta_label | escape }}
            </button>
            <button type="button" class="smwpop__secondary" data-smwpop-close>
              {{ section.settings.secondary_label | escape }}
            </button>
          </div>
        </div>

        {% if section.settings.show_image %}
          <div class="smwpop__right">
            <div class="smwpop__shot">
              {% if section.settings.screenshot != blank %}
                <img
                  src="{{ section.settings.screenshot | image_url: width: 1600 }}"
                  alt="{{ section.settings.image_caption | escape }}"
                  loading="lazy"
                  width="1600"
                  height="1000"
                >
              {% else %}
                <img
                  src="https://placehold.co/1600x1000"
                  alt="Placeholder"
                  loading="lazy"
                  width="1600"
                  height="1000"
                >
              {% endif %}
            </div>
            {% if section.settings.image_caption != blank %}
              <p class="smwpop__caption">{{ section.settings.image_caption | escape }}</p>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    (function(){
      var root = document.getElementById("smw-popup-{{ section.id }}");
      if(!root) return;

      var overlay = root.querySelector("[data-smwpop-overlay]");
      var panel = root.querySelector("[data-smwpop-panel]");
      var openBtns = root.querySelectorAll("[data-smwpop-open]");
      var closeBtns = root.querySelectorAll("[data-smwpop-close]");

      var autoOpen = {{ section.settings.auto_open | json }};
      var delayMs = ({{ section.settings.open_delay_seconds | default: 1 }} * 1000) || 0;
      var oncePerSession = {{ section.settings.once_per_session | json }};
      var seenKey = "smwpop_seen_{{ section.id }}";

      var prevBodyOverflow = null;

      function lockScroll(){
        try{
          prevBodyOverflow = document.body.style.overflow;
          document.body.style.overflow = "hidden";
        }catch(e){}
      }

      function unlockScroll(){
        try{
          document.body.style.overflow = prevBodyOverflow || "";
        }catch(e){}
      }

      function isSeen(){
        if(!oncePerSession) return false;
        try{ return sessionStorage.getItem(seenKey) === "1"; }catch(e){ return false; }
      }

      function setSeen(){
        if(!oncePerSession) return;
        try{ sessionStorage.setItem(seenKey, "1"); }catch(e){}
      }

      function open(){
        if(root.classList.contains("is-open")) return;
        root.classList.add("is-open");
        lockScroll();
        setSeen();
        if(panel) panel.focus({ preventScroll: true });
      }

      function close(){
        if(!root.classList.contains("is-open")) return;
        root.classList.remove("is-open");
        unlockScroll();
      }

      openBtns.forEach(function(btn){
        btn.addEventListener("click", function(e){
          e.preventDefault();
          open();
        });
      });

      closeBtns.forEach(function(btn){
        btn.addEventListener("click", function(e){
          e.preventDefault();
          close();
        });
      });

      if(overlay){
        overlay.addEventListener("click", function(e){
          if(e.target === overlay) close();
        });
      }

      document.addEventListener("keydown", function(e){
        if(!root.classList.contains("is-open")) return;
        if(e.key === "Escape") close();
      });

      function maybeAutoOpen(){
        if(!autoOpen) return;
        if(isSeen()) return;
        window.setTimeout(function(){
          if(isSeen()) return;
          open();
        }, Math.max(0, delayMs));
      }

      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", maybeAutoOpen);
      } else {
        maybeAutoOpen();
      }

      document.addEventListener("shopify:section:unload", function(e){
        if(!e || !e.detail || !e.detail.sectionId) return;
        if(String(e.detail.sectionId) !== String("{{ section.id }}")) return;
        unlockScroll();
      });
    })();
  </script>
</section>
{% endif %}