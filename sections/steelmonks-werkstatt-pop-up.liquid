{% comment %}
  File name
  steelmonks-werkstatt-pop-up.liquid

  Werkstatt Pop Up
  Fixes
  - Overlay wird per JS in den Body verschoben, damit es garantiert über allem liegt
  - Seite wird dahinter blurry durch backdrop filter
  - Kein X Button, nur Alles klar schließt
  - Text und Labels im Theme Editor editierbar
  - Mobile optimized, Panel max height, scrollt sauber wenn nötig
{% endcomment %}

{% schema %}
{
  "name": "Werkstatt Pop Up",
  "tag": "section",
  "settings": [
    { "type": "checkbox", "id": "enabled", "label": "Popup aktiv", "default": true },

    { "type": "header", "content": "Öffnen" },
    { "type": "checkbox", "id": "auto_open", "label": "Automatisch öffnen", "default": true },
    { "type": "range", "id": "open_delay_seconds", "label": "Delay in Sekunden", "default": 1, "min": 0, "max": 20, "step": 1 },
    { "type": "checkbox", "id": "once_per_session", "label": "Nur einmal pro Session anzeigen", "default": true },

    { "type": "checkbox", "id": "show_trigger", "label": "Hinweis Pille anzeigen", "default": true },

    { "type": "header", "content": "Text" },
    { "type": "text", "id": "pill_label", "label": "Pille Text", "default": "Werkstatt Hinweis" },
    { "type": "text", "id": "heading", "label": "Überschrift", "default": "Willkommen in der Werkstatt" },
    { "type": "textarea", "id": "body", "label": "Text", "default": "Unsere Werkstatt ist das einzige Tool seiner Art. Damit kannst du dein eigenes Metallschild direkt online gestalten.\n\nBitte behalte im Kopf, dass hier mehrere externe Dienste zusammenspielen. In seltenen Fällen kann etwas kurz hängen.\n\nWenn etwas nicht lädt oder sich komisch verhält, lade die Seite neu und probiere es nochmal. Danke, dass du offen bleibst und es testest." },
    { "type": "text", "id": "cta_label", "label": "Button Text", "default": "Alles klar" },

    { "type": "header", "content": "Style" },
    { "type": "range", "id": "modal_max_width", "label": "Modal Max Breite", "default": 760, "min": 520, "max": 980, "step": 10 },
    { "type": "range", "id": "radius", "label": "Ecken Radius", "default": 26, "min": 14, "max": 40, "step": 1 },
    { "type": "range", "id": "blur_strength", "label": "Blur Stärke", "default": 16, "min": 8, "max": 26, "step": 1 },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay Deckkraft", "default": 24, "min": 10, "max": 55, "step": 1 },

    { "type": "color", "id": "accent_1", "label": "Akzent Farbe 1", "default": "#ff9800" },
    { "type": "color", "id": "accent_2", "label": "Akzent Farbe 2", "default": "#0044CC" },
    { "type": "color", "id": "text_color", "label": "Text Farbe", "default": "#0b1220" }
  ],
  "presets": [
    { "name": "Werkstatt Pop Up" }
  ]
}
{% endschema %}

{% if section.settings.enabled %}
<section id="smw-popup-{{ section.id }}" class="smwpop" data-smwpop-root>
  <style>
    #smw-popup-{{ section.id }}{
      --a1: {{ section.settings.accent_1 }};
      --a2: {{ section.settings.accent_2 }};
      --txt: {{ section.settings.text_color }};
      --r: {{ section.settings.radius }}px;
      --maxW: {{ section.settings.modal_max_width }}px;
      --blur: {{ section.settings.blur_strength }}px;
      --overlayA: {{ section.settings.overlay_opacity | divided_by: 100.0 }};
    }

    /* Center pill */
    #smw-popup-{{ section.id }} .smwpop__triggerWrap{
      display: flex;
      justify-content: center;
      margin: 12px 0;
    }

    #smw-popup-{{ section.id }} .smwpop__trigger{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.10);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 46px rgba(15,23,42,0.14);
      cursor: pointer;
      color: rgba(9,10,12,0.82);
      font-weight: 950;
      font-size: 13px;
      letter-spacing: 0.2px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 180ms cubic-bezier(0.2,0.8,0.2,1), filter 180ms ease, background 180ms ease;
    }

    #smw-popup-{{ section.id }} .smwpop__trigger:hover{
      filter: brightness(1.03);
      background: rgba(255,255,255,0.14);
    }

    #smw-popup-{{ section.id }} .smwpop__trigger:active{
      transform: scale(0.985);
    }

    #smw-popup-{{ section.id }} .smwpop__dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,152,0,0.95), rgba(0,68,204,0.90));
      box-shadow: 0 0 0 6px rgba(255,152,0,0.18);
      flex: 0 0 auto;
    }

    /* Overlay is moved into body, so these rules target it by id */
    #smw-overlay-{{ section.id }}{
      position: fixed;
      inset: 0;
      z-index: 2147483647;
      display: none;
      place-items: center;
      padding: 18px 14px;
      background: rgba(8,10,14, var(--overlayA));
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
    }

    #smw-overlay-{{ section.id }}.is-open{
      display: grid;
    }

    #smw-overlay-{{ section.id }} .smwpop__panel{
      width: min(var(--maxW), 100%);
      max-height: calc(100vh - 36px);
      overflow: auto;
      border-radius: var(--r);
      position: relative;
      box-shadow: 0 28px 90px rgba(15,23,42,0.22);
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      isolation: isolate;

      transform: translateY(10px) scale(0.995);
      opacity: 0;
      transition: transform 260ms cubic-bezier(0.2,0.8,0.2,1), opacity 240ms ease;
    }

    #smw-overlay-{{ section.id }}.is-open .smwpop__panel{
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    #smw-overlay-{{ section.id }} .smwpop__panel:before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: calc(var(--r) + 1px);
      padding: 1.5px;
      background: linear-gradient(135deg, rgba(255,152,0,0.65), rgba(0,68,204,0.58));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.92;
      pointer-events:none;
      z-index: 0;
    }

    #smw-overlay-{{ section.id }} .smwpop__panel:after{
      content:"";
      position:absolute;
      inset:-26px;
      border-radius: calc(var(--r) + 28px);
      background:
        radial-gradient(60% 60% at 18% 10%, rgba(255,152,0,0.18), rgba(255,255,255,0) 62%),
        radial-gradient(60% 60% at 86% 10%, rgba(0,68,204,0.16), rgba(255,255,255,0) 62%);
      opacity: 0.42;
      filter: blur(18px);
      pointer-events:none;
      z-index: -1;
    }

    #smw-overlay-{{ section.id }} .smwpop__inner{
      position: relative;
      z-index: 1;
      padding: 22px 22px 18px;
      text-align: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
    }

    #smw-overlay-{{ section.id }} .smwpop__title{
      margin: 0;
      font-weight: 980;
      letter-spacing: -0.01em;
      font-size: clamp(18px, 4.2vw, 30px);
      line-height: 1.12;
      color: rgba(9,10,12,0.88);
    }

    #smw-overlay-{{ section.id }} .smwpop__text{
      margin: 12px auto 0;
      max-width: 56ch;
      font-weight: 850;
      font-size: clamp(13px, 3.3vw, 16px);
      line-height: 1.5;
      color: rgba(9,10,12,0.78);
      white-space: pre-line;
    }

    #smw-overlay-{{ section.id }} .smwpop__actions{
      margin-top: 16px;
      display: flex;
      justify-content: center;
    }

    #smw-overlay-{{ section.id }} .smwpop__cta{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 16px;
      min-width: 160px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: linear-gradient(90deg, rgba(0,35,94,0.78), rgba(0,68,204,0.78));
      color: rgba(255,255,255,0.96);
      font-weight: 950;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 20px 56px rgba(0,35,94,0.22);
      transition: transform 180ms cubic-bezier(0.2,0.8,0.2,1), filter 180ms ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    #smw-overlay-{{ section.id }} .smwpop__cta:hover{
      filter: brightness(1.03);
    }

    #smw-overlay-{{ section.id }} .smwpop__cta:active{
      transform: scale(0.985);
    }

    @media (max-width: 520px){
      #smw-overlay-{{ section.id }} .smwpop__inner{
        padding: 18px 16px 16px;
      }
      #smw-overlay-{{ section.id }} .smwpop__text{
        max-width: 44ch;
      }
      #smw-overlay-{{ section.id }} .smwpop__cta{
        width: 100%;
        min-width: 0;
      }
      #smw-overlay-{{ section.id }}{
        padding: 14px 12px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      #smw-overlay-{{ section.id }} *{
        transition: none !important;
        animation: none !important;
      }
    }
  </style>

  {% if section.settings.show_trigger %}
    <div class="smwpop__triggerWrap">
      <button type="button" class="smwpop__trigger" data-smwpop-open>
        <span class="smwpop__dot" aria-hidden="true"></span>
        <span>{{ section.settings.pill_label | escape }}</span>
      </button>
    </div>
  {% endif %}

  {%- comment -%}
    Overlay markup lives here first, then JS moves it into body to avoid z index fights
  {%- endcomment -%}
  <div id="smw-overlay-{{ section.id }}" class="smwpop__overlay" data-smwpop-overlay role="presentation">
    <div class="smwpop__panel" role="dialog" aria-modal="true" aria-label="{{ section.settings.heading | escape }}" tabindex="-1" data-smwpop-panel>
      <div class="smwpop__inner">
        {% if section.settings.heading != blank %}
          <h2 class="smwpop__title">{{ section.settings.heading | escape }}</h2>
        {% endif %}

        {% if section.settings.body != blank %}
          <p class="smwpop__text">{{ section.settings.body | escape }}</p>
        {% endif %}

        <div class="smwpop__actions">
          <button type="button" class="smwpop__cta" data-smwpop-close>
            {{ section.settings.cta_label | escape }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      var root = document.getElementById("smw-popup-{{ section.id }}");
      if(!root) return;

      var overlay = document.getElementById("smw-overlay-{{ section.id }}");
      if(!overlay) return;

      var panel = overlay.querySelector("[data-smwpop-panel]");
      var openBtns = root.querySelectorAll("[data-smwpop-open]");
      var closeBtn = overlay.querySelector("[data-smwpop-close]");

      var autoOpen = {{ section.settings.auto_open | json }};
      var delayMs = ({{ section.settings.open_delay_seconds | default: 1 }} * 1000) || 0;
      var oncePerSession = {{ section.settings.once_per_session | json }};
      var seenKey = "smwpop_seen_{{ section.id }}";

      var prevBodyOverflow = null;

      function moveOverlayToBody(){
        try{
          if(overlay.parentElement !== document.body){
            document.body.appendChild(overlay);
          }
        }catch(e){}
      }

      function lockScroll(){
        try{
          prevBodyOverflow = document.body.style.overflow;
          document.body.style.overflow = "hidden";
        }catch(e){}
      }

      function unlockScroll(){
        try{
          document.body.style.overflow = prevBodyOverflow || "";
        }catch(e){}
      }

      function isSeen(){
        if(!oncePerSession) return false;
        try{ return sessionStorage.getItem(seenKey) === "1"; }catch(e){ return false; }
      }

      function setSeen(){
        if(!oncePerSession) return;
        try{ sessionStorage.setItem(seenKey, "1"); }catch(e){}
      }

      function open(){
        moveOverlayToBody();
        if(overlay.classList.contains("is-open")) return;
        overlay.classList.add("is-open");
        lockScroll();
        setSeen();
        if(panel) panel.focus({ preventScroll: true });
      }

      function close(){
        if(!overlay.classList.contains("is-open")) return;
        overlay.classList.remove("is-open");
        unlockScroll();
      }

      openBtns.forEach(function(btn){
        btn.addEventListener("click", function(e){
          e.preventDefault();
          open();
        });
      });

      if(closeBtn){
        closeBtn.addEventListener("click", function(e){
          e.preventDefault();
          close();
        });
      }

      overlay.addEventListener("click", function(e){
        if(e.target === overlay) close();
      });

      document.addEventListener("keydown", function(e){
        if(!overlay.classList.contains("is-open")) return;
        if(e.key === "Escape") close();
      });

      function maybeAutoOpen(){
        if(!autoOpen) return;
        if(isSeen()) return;
        window.setTimeout(function(){
          if(isSeen()) return;
          open();
        }, Math.max(0, delayMs));
      }

      moveOverlayToBody();

      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", maybeAutoOpen);
      } else {
        maybeAutoOpen();
      }

      document.addEventListener("shopify:section:unload", function(e){
        if(!e || !e.detail || !e.detail.sectionId) return;
        if(String(e.detail.sectionId) !== String("{{ section.id }}")) return;
        unlockScroll();
        try{ overlay.remove(); }catch(err){}
      });
    })();
  </script>
</section>
{% endif %}