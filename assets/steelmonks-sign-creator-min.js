document.addEventListener("DOMContentLoaded",(()=>{const e=18e4,t=25e3,r=7e4,a=9e4,n=24e4,i=1e4,o={run:"/apps/creator/run-creator",sign:"/apps/creator/get-creator-sign",product:"/apps/creator/get-creator-product"},l=(()=>{const e=window.SMCREATOR_ENDPOINTS||{},t={...o};try{Object.keys(e).forEach((r=>{null!=e[r]&&""!==String(e[r]).trim()&&(t[r]=e[r])}))}catch(e){}return t})(),s={FAILED:"Fehlgeschlagen",PREVIEW_READY:"Vorschau ist fertig",DESIGN_READY:["Entwurf ist fertig","Design ist Fertig","Entwurf ist fertig.","Design ist fertig"]},c=e=>document.getElementById(e),d=e=>{const t=Math.max(0,Math.ceil(e/1e3)),r=Math.floor(t/60),a=t%60;return`${String(r).padStart(2,"0")}:${String(a).padStart(2,"0")}`},u=e=>{try{return JSON.parse(e)}catch(e){return null}},p=e=>{if(!e)return"";const t=String(e).trim();return/^https?:\/\//i.test(t)?t:/^[a-zA-Z0-9_-]{10,}$/.test(t)?(r=t)?`https://lh3.googleusercontent.com/d/${r}`:"":"";var r},m=(e,t)=>{const r=e=>e&&"object"==typeof e&&null!=e[t]?String(e[t]):"";return e?Array.isArray(e)&&e[0]?r(e[0]):r(e):""},h={slider:c("smc-slider"),page1:c("smc-page-1"),page2:c("smc-page-2"),page3:c("smc-page-3"),upload:c("smc-upload"),uploadLabel:c("smc-upload-label"),uploadPrevImg:c("smc-upload-preview"),uploadPrevEmpty:c("smc-upload-preview-empty"),desc:c("smc-desc"),finish:c("smc-finish"),size:c("smc-size"),note:c("smc-note"),type:c("smc-type"),bolts:c("smc-bolts"),pill:c("smc-pill"),pillText:c("smc-pill-text"),priceVal:c("smc-price"),previewLoading:c("smc-preview-loading"),previewEmpty:c("smc-preview-empty"),previewImg:c("smc-preview-img"),previewDownload:c("smc-preview-download"),previewShare:c("smc-preview-share"),previewActions:c("smc-preview-actions"),resultImg:c("smc-result-img"),productName:c("smc-product-name"),confirmBtn:c("smc-confirm-btn"),confirmBtnWrap:c("smc-confirm-btn-wrap"),backBtn:c("smc-back-btn"),etaWrap:c("smc-eta"),etaLabel:c("smc-eta-label"),etaTime:c("smc-eta-time"),ctaBtn:c("smc-cta-btn"),ctaLabel:c("smc-cta-label"),openBtn:c("smc-open-btn"),continueBtn:c("smc-continue-btn"),continueLabel:c("smc-continue-label"),propImg:c("smc-prop-img"),propDesc:c("smc-prop-desc"),propFinish:c("smc-prop-finish"),propSize:c("smc-prop-size"),propRoute:c("smc-prop-route"),propGen:c("smc-prop-gen"),propPrice:c("smc-prop-price"),propNote:c("smc-prop-note"),propType:c("smc-prop-type"),propBolts:c("smc-prop-bolts"),smc:c("smc"),smcContainer:c("smc-container")};if(h.desc)try{h.desc.placeholder="Lass Deiner Vorstellung freien Lauf. Probier doch:\n• Ein schönes Familienschild mit unserem Labradoodle wie aus dem Foto\n• Mein Familienwappen wie aus der Zeichnung\n• Mach mir ein Schild für meinen Bruder, er liebt Schlagzeug und Croissants\n• Oder ein Hausschild mit der Nummer 22 und einem Ritter"}catch(e){}const g={current:"init",locked:!1,generatorId:"",lastMockUrl:"",lastEntUrl:"",priceReady:!1,priceRequested:!1,pendingPriceValue:"",previewDone:!1,previewInFlight:!1,forceMockLoading:!1,runStartedAt:0,pollInFlight:!1,generatedProductUrl:"",generatedProductName:"",generatedProductId:"",generatedVariantId:"",hasGeneratedDesign:!1,designConfirmed:!1,cooldown:null},v="steelmonks-sign-creator-state-123",w="steelmonks-sign-creator-timer-123",f="steelmonks-sign-creator-form-123",y={saveState(){try{const e={current:g.current,generatorId:g.generatorId,lastMockUrl:g.lastMockUrl,lastEntUrl:g.lastEntUrl,priceReady:g.priceReady,pendingPriceValue:g.pendingPriceValue,previewDone:g.previewDone,runStartedAt:g.runStartedAt,generatedProductUrl:g.generatedProductUrl,generatedProductName:g.generatedProductName,generatedProductId:g.generatedProductId,generatedVariantId:g.generatedVariantId,hasGeneratedDesign:g.hasGeneratedDesign,designConfirmed:g.designConfirmed,cooldown:g.cooldown,createdAt:this.getCreatedAt()||Date.now()};localStorage.setItem(v,JSON.stringify(e))}catch(e){}},getCreatedAt(){try{const e=localStorage.getItem(v);if(!e)return null;return JSON.parse(e).createdAt||null}catch(e){return null}},isStateExpired(){const e=this.getCreatedAt();if(!e)return!1;const t=Date.now()-e>864e5;return t},loadState(){try{if(this.isStateExpired())return this.clearState(),null;const e=localStorage.getItem(v);if(!e)return null;const t=JSON.parse(e);return t.createdAt||(t.createdAt=Date.now(),localStorage.setItem(v,JSON.stringify(t))),t}catch(e){return null}},clearState(){try{localStorage.removeItem(v),localStorage.removeItem(w),localStorage.removeItem(f)}catch(e){}},saveTimer(e){try{e&&e>Date.now()?localStorage.setItem(w,JSON.stringify({etaEndsAt:e})):localStorage.removeItem(w)}catch(e){}},loadTimer(){try{const e=localStorage.getItem(w);if(!e)return null;const t=JSON.parse(e);return t.etaEndsAt&&t.etaEndsAt>Date.now()?t:(localStorage.removeItem(w),null)}catch(e){return null}},saveFormData(){try{const e={description:h.desc?.value||"",finish:h.finish?.value||"",size:h.size?.value||"",note:h.note?.value||"",type:h.type?.value||"",bolts:h.bolts?.value||"",uploadFileName:h.upload?.files?.[0]?.name||"",uploadDataUrl:null},t=h.upload?.files?.[0];if(t&&t.type?.startsWith("image")){const r=new FileReader;r.onload=t=>{try{e.uploadDataUrl=t.target?.result||null,localStorage.setItem(f,JSON.stringify(e))}catch(e){}},r.onerror=t=>{localStorage.setItem(f,JSON.stringify(e))},r.readAsDataURL(t)}else localStorage.setItem(f,JSON.stringify(e))}catch(e){}},loadFormData(){try{const e=localStorage.getItem(f);if(!e)return null;return JSON.parse(e)}catch(e){return null}},restoreFormData(e){if(e)try{e.description&&h.desc&&(h.desc.value=e.description),e.finish&&h.finish&&(h.finish.value=e.finish),e.size&&h.size&&(h.size.value=e.size),e.note&&h.note&&(h.note.value=e.note),e.type&&h.type&&(h.type.value=e.type),e.bolts&&h.bolts&&(h.bolts.value=e.bolts),e.uploadDataUrl&&h.uploadPrevImg&&h.uploadPrevEmpty&&(h.uploadPrevImg.src=e.uploadDataUrl,h.uploadPrevImg.style.display="block",h.uploadPrevEmpty.style.display="none",h.uploadLabel&&(h.uploadLabel.textContent=e.uploadFileName||"Bild hochgeladen")),b.updateProps()}catch(e){}}},P={etaTick:null,etaEndsAt:0,holdTick:null,holdEndsAt:0,priceA:null,entwurf:null,mock:null,mockPoll:null,mockPollEndsAt:0},k={clearAll(){P.etaTick&&clearInterval(P.etaTick),P.holdTick&&clearInterval(P.holdTick),P.priceA&&clearTimeout(P.priceA),P.entwurf&&clearTimeout(P.entwurf),P.mock&&clearTimeout(P.mock),P.mockPoll&&clearInterval(P.mockPoll),Object.assign(P,{etaTick:null,etaEndsAt:0,holdTick:null,holdEndsAt:0,priceA:null,entwurf:null,mock:null,mockPoll:null,mockPollEndsAt:0})},stopEta(){P.etaTick&&clearInterval(P.etaTick),P.etaTick=null,P.etaEndsAt=0,y.saveTimer(null),h.etaWrap&&(h.etaWrap.style.display="none")},startEta(e,t,r){this.stopEta(),P.etaEndsAt=Date.now()+t,y.saveTimer(P.etaEndsAt),h.etaLabel&&(h.etaLabel.textContent=e||"Geschätzte Zeit"),h.etaWrap&&(h.etaWrap.style.display="flex");const a=()=>{try{const e=P.etaEndsAt-Date.now();if(h.etaTime&&(h.etaTime.textContent=d(e)),e<=0&&(this.stopEta(),r))try{r()}catch(e){}}catch(e){}};a(),P.etaTick=setInterval(a,1e3)},restoreEta(){const e=y.loadTimer();if(e&&e.etaEndsAt){P.etaEndsAt=e.etaEndsAt;if(P.etaEndsAt-Date.now()>0){h.etaLabel&&(h.etaLabel.textContent="Geschätzte Zeit"),h.etaWrap&&(h.etaWrap.style.display="flex");const e=()=>{try{const e=P.etaEndsAt-Date.now();h.etaTime&&(h.etaTime.textContent=d(e)),e<=0&&this.stopEta()}catch(e){}};return e(),P.etaTick=setInterval(e,1e3),!0}y.saveTimer(null)}return!1},stopHold(){P.holdTick&&clearInterval(P.holdTick),P.holdTick=null,P.holdEndsAt=0}},S={setPillState(e,t){h.pill&&h.pill.setAttribute("data-state",e||"idle"),h.pillText&&(h.pillText.textContent=t||"Bereit")},setPreviewLoading(e){h.previewLoading&&(h.previewLoading.style.display=e?"flex":"none")},showPreview(e){e?(this.setPreviewLoading(!0),h.previewEmpty&&(h.previewEmpty.style.display="none"),h.previewImg&&(h.previewImg.src="",h.previewImg.onload=()=>{this.setPreviewLoading(!1),h.previewEmpty&&(h.previewEmpty.style.display="none")},h.previewImg.onerror=()=>{this.setPreviewLoading(!1),h.previewEmpty&&(h.previewEmpty.textContent="Fehler beim Laden der Vorschau",h.previewEmpty.style.display="block"),h.previewActions&&h.previewActions.classList.add("twcss-hidden"),h.previewDownload&&(h.previewDownload.disabled=!0),h.previewShare&&(h.previewShare.disabled=!0)},h.previewImg.src=e,h.previewImg.classList.remove("twcss-hidden"),h.previewActions&&h.previewActions.classList.remove("twcss-hidden"),h.previewDownload&&(h.previewDownload.disabled=!1),h.previewShare&&(h.previewShare.disabled=!1),h.continueBtn&&"creating"===g.current&&(h.continueBtn.disabled=!1)),h.resultImg&&(h.resultImg.src=e,h.resultImg.classList.remove("twcss-hidden"))):this.showPlaceholder("Keine Vorschau verfügbar")},showPlaceholder(e){h.previewEmpty&&(h.previewEmpty.textContent=e||"Starte zuerst den Entwurf",h.previewEmpty.style.display="block"),h.previewImg&&h.previewImg.classList.add("twcss-hidden"),h.previewActions&&h.previewActions.classList.add("twcss-hidden"),h.previewDownload&&(h.previewDownload.disabled=!0),h.previewShare&&(h.previewShare.disabled=!0),this.setPreviewLoading(!1)},lockInputs(e){g.locked=!!e},lockScroll(e){try{const t=e?"hidden":"";document.documentElement.style.overflow=t,document.body.style.overflow=t}catch(e){}},setCta(e,t){h.ctaLabel&&(h.ctaLabel.textContent=e||"Entwurf erstellen"),h.ctaBtn&&(h.ctaBtn.disabled=!t)},setCtaFromState(){switch(g.current){case"init":{if(g.generatedVariantId||g.generatedProductUrl)return void this.setCta("Weiter →",!0);if(g.hasGeneratedDesign&&(g.lastMockUrl||g.lastEntUrl))return void this.setCta("Weiter →",!0);const e=h.desc?.value?.trim().length>=5,t=this.checkCooldown();if(t.isOnCooldown)return void this.setCta(t.countdownText,!1);this.setCta("Entwurf erstellen",e&&!g.locked);break}case"creating":this.setCta("Weiter →",!0);break;case"ready":this.setCta("Weiter →",!0);break;default:this.setCta("Wird erstellt",!1)}},checkCooldown(){if(!g.cooldown)return{isOnCooldown:!1,countdownText:""};const e=Date.now(),t=g.cooldown-e;if(t<=0)return g.cooldown=null,y.saveState(),{isOnCooldown:!1,countdownText:""};const r=Math.floor(t/6e4),a=Math.floor(t%6e4/1e3);return{isOnCooldown:!0,countdownText:`Bitte warten (${String(r).padStart(2,"0")}:${String(a).padStart(2,"0")})`}},navigateTo(e){if(!h.slider)return;let t="0%";switch(e){case 1:t="0%";break;case 2:t="-100%";break;case 3:t="-200%";break;default:t="0%"}[h.page1,h.page2,h.page3].forEach(((t,r)=>{if(t){r===e-1?(t.style.opacity="0",t.style.transition="opacity 0.3s ease-in-out",requestAnimationFrame((()=>{t&&(t.style.opacity="1")}))):(t.style.opacity="0",t.style.transition="opacity 0.3s ease-in-out")}})),h.slider.style.transform=`translateX(${t})`},updateUIFromState(){switch(g.current){case"init":this.navigateTo(1);break;case"creating":this.navigateTo(2),h.continueBtn&&(h.continueBtn.disabled=!g.lastMockUrl&&!g.lastEntUrl),h.confirmBtnWrap&&h.confirmBtnWrap.classList.remove("hidden"),h.confirmBtn&&!g.designConfirmed&&(h.confirmBtn.disabled=!1),(g.generatedVariantId||g.generatedProductUrl||g.designConfirmed)&&h.confirmBtnWrap&&h.confirmBtnWrap.classList.add("hidden");break;case"ready":this.navigateTo(3),g.generatedProductName&&h.productName&&(h.productName.textContent=g.generatedProductName),h.confirmBtnWrap&&h.confirmBtnWrap.classList.add("hidden"),(g.generatedVariantId||g.generatedProductUrl||g.designConfirmed)&&h.confirmBtnWrap&&h.confirmBtnWrap.classList.add("hidden"),h.continueBtn&&(h.continueBtn.disabled=!1),"function"==typeof T&&T();break;default:this.navigateTo(1)}this.setCtaFromState()},applyPriceDisplay(){h.priceVal&&(g.pendingPriceValue?h.priceVal.textContent=g.pendingPriceValue:h.priceVal.textContent="Den Preis berechnen wir nach dem Entwurf.")}},b={hasImage:()=>!!h.upload?.files?.[0],routeValue(){return this.hasImage()?"Edit":"Generate"},updateProps(){h.propDesc&&(h.propDesc.value=h.desc?.value||""),h.propFinish&&(h.propFinish.value=h.finish?.value||""),h.propSize&&(h.propSize.value=h.size?.value||""),h.propRoute&&(h.propRoute.value=this.routeValue()),h.propGen&&(h.propGen.value=g.generatorId||""),h.propImg&&(h.propImg.value=h.upload?.files?.[0]?.name||""),h.propPrice&&(h.propPrice.value=g.pendingPriceValue||""),h.propNote&&h.note&&(h.propNote.value=h.note.value||""),h.propType&&h.type&&(h.propType.value=h.type.value||""),h.propBolts&&h.bolts&&(h.propBolts.value=h.bolts.value||"")},createPayload(e={}){const t=new FormData,r=h.upload?.files?.[0],a=h.finish?.value||"",n=h.size?.value||"",i=h.bolts?.value||"";a&&n&&I.calculate(a,n,i),t.append("Bild",r||""),t.append("Beschreibung",h.desc?.value||""),t.append("Oberfläche",h.finish?.value||""),t.append("Größe",h.size?.value||""),t.append("Type",h.type?.value||""),t.append("Route",this.routeValue()),t.append("generator_id",g.generatorId||""),t.append("section_id",sid);const o="Befestigung"===i;t.append("Befestigung",String(o)),g.pendingPriceValue&&t.append("Preis",Number(g.pendingPriceValue.replace("€","").trim().replace(",",".")));try{Object.keys(e).forEach((r=>{null!=e[r]&&t.append(r,e[r])}))}catch(e){}return t},handleUploadUI(){if(!h.upload||!h.uploadLabel)return;const e=h.upload.files?.[0];if(e){if(h.uploadLabel.textContent=e.name,e.type?.startsWith("image")){const t=new FileReader;t.onload=e=>{try{h.uploadPrevImg&&h.uploadPrevEmpty&&(h.uploadPrevImg.src=e.target?.result||"",h.uploadPrevImg.style.display="block",h.uploadPrevEmpty.style.display="none")}catch(e){}},t.onerror=e=>{};try{t.readAsDataURL(e)}catch(e){}}}else h.uploadLabel.textContent="Noch kein Upload",h.uploadPrevImg&&h.uploadPrevEmpty&&(h.uploadPrevImg.removeAttribute("src"),h.uploadPrevImg.style.display="none",h.uploadPrevEmpty.style.display="flex")}},E={"Schwarz pulverbeschichtet":{"22,5 cm":59,"45 cm":89,"55 cm":99,"75 cm":169,"75 cm+":0},"Anthrazit pulverbeschichtet":{"22,5 cm":59,"45 cm":89,"55 cm":99,"75 cm":169,"75 cm+":0},"Weiß pulverbeschichtet":{"22,5 cm":59,"45 cm":89,"55 cm":99,"75 cm":169,"75 cm+":0},Gold:{"22,5 cm":59,"45 cm":89,"55 cm":99,"75 cm":169,"75 cm+":0},"Cortenstahl Optik":{"22,5 cm":69,"45 cm":99,"55 cm":129,"75 cm":199,"75 cm+":0},"Satinierter Edelstahl":{"22,5 cm":69,"45 cm":99,"55 cm":129,"75 cm":199,"75 cm+":0}},I={calculate(e,t,r=""){const a=((e,t,r="")=>{if(!e||!t)return null;const a=E[e];if(!a)return null;const n=a[t];if(void 0===n)return null;if(0===n&&"75 cm+"===t)return null;let i=n;return"Befestigung"===r&&(i+=9.45),i})(e,t,r),n=(e=>null==e?"":`${Number(e).toFixed(2).replace(".",",")} €`)(a);if(n)return g.pendingPriceValue=n,g.priceReady=!0,y.saveState(),b.updateProps(),S.applyPriceDisplay(),"creating"!==g.current||g.lastMockUrl||S.setPillState("work","Preis berechnet"),n;g.priceReady;return g.pendingPriceValue="",g.priceReady=!1,y.saveState(),b.updateProps(),e&&t?h.priceVal&&(h.priceVal.textContent="Preis auf Anfrage"):h.priceVal&&(h.priceVal.textContent="Den Preis berechnen wir nach dem Entwurf."),null},set(e){const t=(e=>{const t=null==e?"":String(e).trim();return t?t.includes("€")?t:/[0-9]/.test(t)?`${t} €`:t:""})(e);t?(g.pendingPriceValue=t,g.priceReady=!0,y.saveState(),b.updateProps(),S.applyPriceDisplay(),"creating"!==g.current||g.lastMockUrl||S.setPillState("work","Preis berechnet")):(g.pendingPriceValue="",g.priceReady=!1,b.updateProps(),S.applyPriceDisplay())},setCalculating(){h.priceVal&&(h.priceVal.textContent="Preis wird berechnet…"),g.pendingPriceValue="",g.priceReady=!1,b.updateProps()}},C={async postText(e,r){const a="AbortController"in window?new AbortController:null;let n=null;a&&(n=setTimeout((()=>{try{a.abort()}catch(e){}}),t));try{const t=await fetch(e,{method:"POST",body:r,signal:a?.signal});n&&clearTimeout(n);const i=await t.text();if(!t.ok)throw new Error(i||`HTTP ${t.status}`);return i}catch(e){throw n&&clearTimeout(n),e.name,e}},async fetchSignOnce(e){if(!g.generatorId||g.pollInFlight)return null;g.pollInFlight=!0;try{const t=await this.postText(l.sign,b.createPayload()),r=u(t),a=(m(r,"Status")||"").trim();D.updateFromStatus(a);const n=m(r,"Preis");if(n&&!g.pendingPriceValue&&I.set(n),a===s.FAILED)return this.handleFailure(),{failed:!0,json:r};if("entwurf"===e||"any"===e){const e=p(m(r,"Entwurf"));e&&(g.lastEntUrl=e,y.saveState(),S.setPreviewLoading(!1),S.showPreview(e))}if("mock"===e||"any"===e){const e=p(m(r,"Mock Up"));if(e)return g.lastMockUrl=e,g.forceMockLoading=!1,k.stopEta(),k.clearAll(),S.setPreviewLoading(!1),S.applyPriceDisplay(),S.showPreview(e),h.resultImg&&(h.resultImg.src=e,h.resultImg.classList.remove("twcss-hidden")),g.hasGeneratedDesign=!0,g.cooldown=Date.now()+3e4,y.saveState(),S.setPillState("ok","Fertig!"),h.continueBtn&&(h.continueBtn.disabled=!1),S.updateUIFromState(),{ok:!0,mock:!0,json:r}}return{ok:!0,json:r}}catch(e){return null}finally{g.pollInFlight=!1}},async prepareProduct(){try{const e=await this.postText(l.product,b.createPayload()),t=u(e);let r="",a="",n="",i="";const o=(e,t)=>{if(!e)return"";for(const r of t)if(null!=e[r])return e[r];return""},s=["Product URL","product_url","url"],c=["Product ID","product_id","id"],d=["Variant ID","variant_id","variant"],p=["Product Name","product_name","name","title"],m=Array.isArray(t)&&t[0]?t[0]:t,v=m?.product||m;if(r=o(m,s)||o(v,s)||"",!r&&v?.handle&&(r=`/products/${v.handle}`),r=String(r).trim(),a=o(m,c)||o(v,c)||"",!a&&v?.id&&(a=v.id),a=String(a).trim(),n=o(m,d)||o(v,d)||"",!n&&v?.variants&&Array.isArray(v.variants)&&v.variants.length>0&&(n=v.variants[0].id),n=String(n).trim(),i=o(m,p)||o(v,p)||"",i=String(i).trim(),r&&(!a||!n))try{const e=(e=>{try{const t=new URL(e,window.location.origin);return`${t.origin}${t.pathname.replace(/\/$/,"")}.js`}catch(e){return""}})(r);if(e){const t=await fetch(e);if(t.ok){const e=await t.json(),r=e.product||e;a||(a=String(r.id||"").trim()),i||(i=String(r.title||"").trim()),!n&&r.variants&&r.variants.length>0&&(n=String(r.variants[0].id).trim())}}}catch(e){}i&&(g.generatedProductName=i,h.productName&&(h.productName.textContent=i)),r&&(g.generatedProductUrl=r),a&&(g.generatedProductId=a),n&&(g.generatedVariantId=n),y.saveState()}catch(e){}},handleFailure(){k.stopEta(),k.clearAll(),S.setPreviewLoading(!1),S.showPlaceholder("Fehlgeschlagen. Bitte Neu anfangen"),g.current="init",S.updateUIFromState()},startMockPollingWindow(){if(P.mockPoll)return;const e=g.runStartedAt?g.runStartedAt+a:Date.now(),t=g.runStartedAt?g.runStartedAt+n:Date.now()+15e4;P.mockPollEndsAt=t,Date.now()>=e&&this.fetchSignOnce("mock"),P.mockPoll=setInterval((async()=>{try{if(!g.generatorId||Date.now()>P.mockPollEndsAt)return clearInterval(P.mockPoll),void(P.mockPoll=null);await this.fetchSignOnce("mock")}catch(e){}}),i)},async startRunCreator(){if((h.desc?.value?.trim()||"").length<5)return;if(S.checkCooldown().isOnCooldown)S.setCtaFromState();else{Object.assign(g,{current:"creating",locked:!1,generatorId:"",lastMockUrl:"",lastEntUrl:"",priceReady:!1,priceRequested:!1,pendingPriceValue:"",previewDone:!1,previewInFlight:!1,forceMockLoading:!1,runStartedAt:Date.now(),pollInFlight:!1,generatedProductUrl:"",generatedProductName:""}),y.saveState(),y.saveFormData(),k.stopEta(),k.stopHold(),k.clearAll(),I.setCalculating(),S.setPillState("work","Wir starten…"),S.lockInputs(!0),"creating"!==g.current&&(g.current="creating",y.saveState()),S.updateUIFromState(),S.showPlaceholder("Wir erstellen gerade deine Vorschau"),S.setPreviewLoading(!0),k.startEta("Geschätzte Zeit",e,(()=>{"creating"!==g.current||g.lastMockUrl||(g.forceMockLoading=!0,S.setPillState("work","Vorschau wird geladen"),S.setPreviewLoading(!0))})),b.updateProps();try{if("undefined"==typeof sid)return void this.handleFailure();let e,t,n;try{e=b.createPayload()}catch(e){throw e}try{t=await this.postText(l.run,e)}catch(e){throw e}if(!t||"string"!=typeof t)return void this.handleFailure();try{n=(e=>{const t=e.match(/"id"\s*:\s*"([^"]+)"/i);return t?t[1]:""})(t)}catch(e){throw e}if(!n)return void this.handleFailure();g.generatorId=n,"creating"!==g.current&&(g.current="creating"),y.saveState(),b.updateProps(),S.setPillState("work","Wird erstellt"),P.entwurf=setTimeout((async()=>{try{S.setPillState("work","Entwurf wird geladen"),await this.fetchSignOnce("entwurf")}catch(e){}}),r),P.mock=setTimeout((()=>{try{S.setPillState("work","Finale Vorschau wird geladen"),this.startMockPollingWindow()}catch(e){}}),a)}catch(e){this.handleFailure()}}}},D={updateFromStatus(e){const t=(e||"").trim();if(!g.forceMockLoading||g.lastMockUrl||!s.DESIGN_READY.includes(t))if(t)switch(t){case s.FAILED:S.setPillState("bad","Fehlgeschlagen");break;case s.PREVIEW_READY:S.setPillState("ok","Vorschau ist fertig");break;case s.DESIGN_READY[0]:S.setPillState("work","Entwurf ist fertig");break;default:S.setPillState("work",t)}else S.setPillState("work","Bitte warten")}},A={async downloadUrl(e,t){if(!e)return;const r=t||`steelmonks-vorschau-${g.generatorId||"download"}.png`;try{const t=await fetch(e,{method:"GET",mode:"cors"});if(!t.ok)throw new Error("download");const a=await t.blob(),n=URL.createObjectURL(a),i=document.createElement("a");i.href=n,i.download=r,document.body.appendChild(i),i.click(),i.remove(),setTimeout((()=>{try{URL.revokeObjectURL(n)}catch(e){}}),8e3)}catch(t){try{const t=document.createElement("a");t.href=e,t.download=r,document.body.appendChild(t),t.click(),t.remove()}catch(t){window.open(e,"_blank")}}}},L={async shareUrl(e,t="Mein personalisiertes Schild"){if(!e)return!1;if(navigator.share)try{return await navigator.share({title:t,text:"Schau dir mein personalisiertes Schild an!",url:e}),!0}catch(e){if("AbortError"===e.name)return!1}try{if(await navigator.clipboard.writeText(e),h.previewShare){const e=h.previewShare.textContent;h.previewShare.textContent="Kopiert!",setTimeout((()=>{h.previewShare&&(h.previewShare.textContent=e)}),2e3)}return!0}catch(t){return alert(`Link zum Teilen:\n${e}`),!1}}},U=document.querySelector("[data-back-to-config]");U&&U.addEventListener("click",(()=>{try{S.navigateTo(1),S.setCtaFromState()}catch(e){}}));document.querySelectorAll("[data-close-button]").forEach((e=>{e.addEventListener("click",(()=>{try{document.body.style.overflow="auto",h.smc?.classList.add("smc--scale-down")}catch(e){}}))})),h.backBtn&&h.backBtn.addEventListener("click",(()=>{try{if(S.checkCooldown().isOnCooldown)return;k.clearAll(),k.stopEta(),Object.assign(g,{current:"init",locked:!1,generatorId:"",lastMockUrl:"",lastEntUrl:"",priceReady:!1,previewDone:!1,runStartedAt:0,generatedProductUrl:"",generatedProductName:"",generatedProductId:"",generatedVariantId:"",hasGeneratedDesign:!1,designConfirmed:!1}),y.saveState(),S.lockInputs(!1),S.setPillState("idle","Bereit"),S.showPlaceholder("Starte zuerst den Entwurf"),S.setPreviewLoading(!1),S.updateUIFromState(),S.setCtaFromState()}catch(e){}}));const T=()=>{if(!h.backBtn)return;const e=S.checkCooldown();if(e.isOnCooldown){h.backBtn.disabled=!0;const t=e.countdownText.match(/\((\d{2}:\d{2})\)/),r=t?t[1]:"";h.backBtn.hasAttribute("data-original-text")||h.backBtn.setAttribute("data-original-text","Neu anfangen"),h.backBtn.textContent=`Neu anfangen (${r})`}else{h.backBtn.disabled=!1;const e=h.backBtn.getAttribute("data-original-text")||"Neu anfangen";h.backBtn.textContent=e,h.backBtn.removeAttribute("data-original-text")}};if(setInterval((()=>{T()}),1e3),h.confirmBtn&&h.confirmBtn.addEventListener("click",(async()=>{try{h.confirmBtn.textContent;if(h.confirmBtn.textContent="Produkt wird erstellt...",h.confirmBtn.disabled=!0,S.setPillState("work","Produkt wird erstellt"),g.generatedVariantId||await C.prepareProduct(),g.generatedVariantId||g.generatedProductUrl){g.current="ready",g.designConfirmed=!0,y.saveState(),S.setPillState("ok","Fertig!"),S.updateUIFromState(),S.setPillState("work","In den Warenkorb...");const e={id:g.generatedVariantId,quantity:1};try{const t=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(e)});if(!t.ok)throw new Error("Failed to add to cart");await t.json();S.setPillState("ok","Im Warenkorb"),window.location.href="/checkout"}catch(e){S.setPillState("bad","Fehler")}}else S.setPillState("bad","Fehler bei Erstellung"),h.confirmBtn.textContent="Erneut versuchen",h.confirmBtn.disabled=!1}catch(e){S.setPillState("bad","Fehler"),h.confirmBtn.textContent="Erneut versuchen",h.confirmBtn.disabled=!1}})),h.upload&&h.upload.addEventListener("change",(()=>{try{if(g.locked)return;b.handleUploadUI(),b.updateProps(),y.saveFormData()}catch(e){}})),h.desc&&h.desc.addEventListener("input",(()=>{try{if(g.locked)return;S.setCtaFromState(),b.updateProps(),y.saveFormData()}catch(e){}}),{passive:!0}),h.note&&h.note.addEventListener("input",(()=>{try{if(g.locked)return;b.updateProps(),y.saveFormData()}catch(e){}}),{passive:!0}),h.type&&h.type.addEventListener("change",(()=>{try{if(g.locked)return;b.updateProps(),y.saveFormData()}catch(e){}})),h.bolts&&h.bolts.addEventListener("change",(()=>{try{if(g.locked)return;b.updateProps(),y.saveFormData();const e=h.finish?.value||"",t=h.size?.value||"",r=h.bolts?.value||"";e&&t&&I.calculate(e,t,r)}catch(e){}})),h.finish&&h.finish.addEventListener("change",(()=>{if(g.locked)return;b.updateProps(),y.saveFormData();const e=h.finish.value||"",t=h.size?.value||"",r=h.bolts?.value||"";I.calculate(e,t,r)})),h.size&&h.size.addEventListener("change",(()=>{try{b.updateProps(),y.saveFormData();const e=h.finish?.value||"",t=h.size.value||"",r=h.bolts?.value||"";if(!e||!t)return;I.calculate(e,t,r)}catch(e){}})),h.ctaBtn&&h.ctaBtn.addEventListener("click",(()=>{try{const e=h.ctaLabel?.textContent?.trim()||"";if("Weiter →"===e||e.includes("Weiter"))return void(("creating"===g.current||"ready"===g.current||"init"===g.current&&(g.lastMockUrl||g.lastEntUrl))&&S.navigateTo(2));"init"===g.current&&C.startRunCreator()}catch(e){}})),h.previewDownload&&h.previewDownload.addEventListener("click",(async()=>{try{const e=g.lastMockUrl||g.lastEntUrl;if(!e)return;await A.downloadUrl(e,`steelmonks-vorschau-${g.generatorId||"download"}.png`)}catch(e){}})),h.previewShare&&h.previewShare.addEventListener("click",(async()=>{try{const e=g.lastMockUrl||g.lastEntUrl;if(!e)return;await L.shareUrl(e,"Mein personalisiertes Schild")}catch(e){}})),h.continueBtn&&h.continueBtn.addEventListener("click",(()=>{try{S.navigateTo(3)}catch(e){}})),h.smc&&h.openBtn){h.openBtn.addEventListener("click",(()=>{try{h.smcContainer.style.opacity="1",h.smcContainer.style.visibility="visible",h.smc.setAttribute("aria-hidden","false"),setTimeout((()=>{try{h.smc.style.transform="scale(1)"}catch(e){}}),300),document.body.style.overflow="hidden"}catch(e){}}));document.querySelectorAll("[data-close-button]").forEach((e=>{e.addEventListener("click",(()=>{try{h.smc.style.transform="scale(0)",setTimeout((()=>{try{h.smcContainer.style.opacity="0",h.smcContainer.style.visibility="hidden",h.smc.setAttribute("aria-hidden","true")}catch(e){}}),300),document.body.style.overflow="auto"}catch(e){}}))}))}try{const e=y.loadState(),t=y.loadFormData();if(e){if(Object.assign(g,{current:e.current||"init",generatorId:e.generatorId||"",lastMockUrl:e.lastMockUrl||"",lastEntUrl:e.lastEntUrl||"",priceReady:e.priceReady||!1,pendingPriceValue:e.pendingPriceValue||"",previewDone:e.previewDone||!1,runStartedAt:e.runStartedAt||0,generatedProductUrl:e.generatedProductUrl||"",generatedProductName:e.generatedProductName||"",generatedProductId:e.generatedProductId||"",generatedVariantId:e.generatedVariantId||"",hasGeneratedDesign:e.hasGeneratedDesign||!1,designConfirmed:e.designConfirmed||!1,cooldown:e.cooldown||null}),t&&y.restoreFormData(t),g.lastMockUrl?(S.showPreview(g.lastMockUrl),"ready"===g.current?(S.setPillState("ok","Entwurf ist fertig"),h.continueBtn&&(h.continueBtn.disabled=!1)):S.setPillState("work","Wird erstellt")):g.lastEntUrl&&(S.showPreview(g.lastEntUrl),S.setPillState("work","Wird erstellt")),g.cooldown){const e=setInterval((()=>{S.checkCooldown().isOnCooldown?("init"===g.current&&h.ctaBtn&&S.setCtaFromState(),"function"==typeof T&&T()):(clearInterval(e),"init"===g.current&&S.setCtaFromState(),"function"==typeof T&&T())}),1e3)}if(g.priceReady&&g.pendingPriceValue)S.applyPriceDisplay();else if(h.finish?.value&&h.size?.value){const e=h.bolts?.value||"";I.calculate(h.finish.value,h.size.value,e)}k.restoreEta(),S.updateUIFromState(),b.updateProps(),"function"==typeof T&&T()}else if(b.handleUploadUI(),b.updateProps(),h.priceVal&&(h.priceVal.textContent="Den Preis berechnen wir nach dem Entwurf."),S.setPillState("idle","Bereit"),S.showPlaceholder("Starte zuerst den Entwurf"),S.setPreviewLoading(!1),S.lockInputs(!1),S.updateUIFromState(),"function"==typeof T&&T(),h.finish?.value&&h.size?.value){const e=h.bolts?.value||"";I.calculate(h.finish.value,h.size.value,e)}}catch(e){S.setPillState("bad","Initialisierungsfehler")}}));